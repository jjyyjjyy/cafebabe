= Elasticsearch
:icons: font
:source-highlighter: highlightjs
:highlightjs-theme: idea
:hardbreaks:
:sectlinks:
:sectnums:
:stem:
:toc: left
:toclevels: 3
:toc-title: 目录
:tabsize: 4
:docinfo: shared

== Elasticsearch介绍

Elasticsearch是一个文档型的NoSQL数据库, 主要用于:

* 实时搜索
* 日志管理
* 数据分析
* 应用监控

== 安装

[source,bash]
----
sudo mkdir -p ~/volumes/es/data0{1..3}/
sudo chmod 777 ~/volumes/es/ -R
----

[source]
.docker-compose.yml
----
version: '3'
services:
    es01:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
        container_name: es01
        environment:
            - node.name=es01
            - discovery.seed_hosts=es02,es03
            - cluster.initial_master_nodes=es01
            - cluster.name=docker-cluster
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
        ulimits:
            memlock:
                soft: -1
                hard: -1
        volumes:
            - ~/volumes/es/data01:/usr/share/elasticsearch/data
        ports:
            - 9200:9200
        networks:
            - esnet
    es02:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
        container_name: es02
        environment:
            - node.name=es02
            - discovery.seed_hosts=es01,es03
            - cluster.initial_master_nodes=es01
            - cluster.name=docker-cluster
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
        ulimits:
            memlock:
                soft: -1
                hard: -1
        volumes:
            - ~/volumes/es/data02:/usr/share/elasticsearch/data
        networks:
            - esnet
    es03:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
        container_name: es03
        environment:
            - node.name=es03
            - discovery.seed_hosts=es01,es02
            - cluster.initial_master_nodes=es01
            - cluster.name=docker-cluster
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
        ulimits:
            memlock:
                soft: -1
                hard: -1
        volumes:
            - ~/volumes/es/data03:/usr/share/elasticsearch/data
        networks:
            - esnet
    kibana:
        container_name: kibana
        image: kibana:7.4.0
        environment:
            - XPACK_GRAPH_ENABLED=true
            - TIMELION_ENABLED=true
            - XPACK_MONITORING_COLLECTION_ENABLED="true"
            - ELASTICSEARCH_HOSTS=http://es01:9200
            - SERVER_HOST=0.0.0.0
            - LOGGING_TIMEZONE=Asia/Shanghai
        ports:
            - 5601:5601
        networks:
            - esnet
    cerebro:
        image: lmenezes/cerebro:0.8.4
        container_name: cerebro
        ports:
            - 9000:9000
        command:
            - -Dhosts.0.host=http://es01:9200
        networks:
            - esnet
networks:
    esnet:
----

== 基本概念

=== 文档

文档以JSON形式存在, 一个文档表示一条数据.
JSON中每个字段都有对应的字段类型 `(boolean/number/string/date/binary/range等)`, 字段类型可以自己指定或者Elasticsearch自动推断.
每个文档都有一个ID, 可以自己指定, 或者Elasticsearch自动生成.

每个文档都有一些元数据字段:

* `_index`: 文档所属的索引名
* `_id`: 文档id
* `_source`: 文档原始JSON数据
* `_version`: 文档版本号
* `_score`: 文档搜索时的评分

=== 索引

表示一类文档的集合.
比如用户索引, 商品索引等.
索引由一个全小写的名称标识, 对文档的CRUD操作均需指定索引名称.
每一个索引都有自己的Mapping, 定义了该索引下文档的字段名和字段类型.

.RDBMS VS Elasticsearch
|===
| RDBMS | Elasticsearch

| Table
| Index

| Row
| Document

| Column
| Field

| Schema
| Mapping

| SQL
| DSL

|===

=== 集群

