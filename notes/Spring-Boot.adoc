= Spring Boot
:icons: font
:source-highlighter: highlightjs
:highlightjs-theme: idea
:sectlinks:
:sectnums:
:stem:
:toc: left
:toclevels: 3
:toc-title: 目录
:tabsize: 4
:docinfo: shared

== 文档

https://docs.spring.io/spring-boot/docs/current/reference/html[window="_blank"]

== 启动流程

=== 初始化SpringApplication

. 初始化 `primarySources` , 并将命令行参数加入到 `primarySources` 中
. 确定ApplicationType: None Web/Servlet/Reactive
. 获取 `META-INF/spring.factories` 中的 `ApplicationContextInitializer` 并设置到 `SpringApplication` 成员变量中
* DelegatingApplicationContextInitializer
* SharedMetadataReaderFactoryContextInitializer
* ContextIdApplicationContextInitializer
* ConfigurationWarningsApplicationContextInitializer
* RSocketPortInfoApplicationContextInitializer
* ServerPortInfoApplicationContextInitializer
* ConditionEvaluationReportLoggingListener
. 获取 `META-INF/spring.factories` 中的 `ApplicationListener` 并设置到 `SpringApplication` 成员变量中
* CloudFoundryVcapEnvironmentPostProcessor
* ConfigFileApplicationListener
* AnsiOutputApplicationListener
* LoggingApplicationListener
* ClasspathLoggingApplicationListener
* BackgroundPreinitializer
* DelegatingApplicationListener
* ParentContextCloserApplicationListener
* ClearCachesApplicationListener
* FileEncodingApplicationListener
* LiquibaseServiceLocatorApplicationListener
. 设置启动类class对象

=== SpringApplication::run

==== 获取配置

. 从 `META-INF/spring.factories` 中获取 `SpringApplicationRunListener` (EventPublishRunListener)
. 发布 *ApplicationStartingEvent*
* LoggingApplicationListener: 设置log system,默认logback。
* BackgroundPreInitializer: 触发内置bean的构造函数。

. 创建Environment对象(StandardServletEnvironment):

* 添加系统属性:
** springApplicationCommandLineArgs(启动命令行参数)
** servletConfigInitParams
** servletContextInitParams
** systemProperties
** systemEnvironment
** defaultProperties(SpringApplication#defaultProperties)

- 根据命令行参数设置active profiles

. 发布**ApplicationEnvironmentPreparedEvent**:

* ConfigFileApplicationListener: 调用EnvironmentPostProcessor#postProcessEnvironment。

** SystemEnvironmentPropertySourceEnvironmentPostProcessor:

       把systemEnvironment包装成OriginAwareSystemEnvironmentPropertySource.

** SpringApplicationJsonEnvironmentPostProcessor:

       解析spring.application.json中的配置, 比systemProperties优先级高

** CloudFoundaryVcapEnvironmentPostProcessor:

       设置vcap属性配置.

** ConfigFileApplicationListener:

       从META-INF/spring.factories中获取ProperySourceLoader(properties/xml/yaml)并读取配置文件。Environment#propertySources中active profile在前,default profile在最后.

* AnsiOutputApplicationListener: 设置 `spring.output.ansi.enabled` 和 `spring.output.ansi.console-available`。

* LoggingApplicationListener: 初始化Log properties/system。

* ClassPathLoggingApplicationListener: 打印classpath日志。

* BackgroundPreinitializer

* DelegatingApplicationListener: 调用 `context.listener.classes` 中listener。

* FileEncodingApplicationListener。

. bindToSpringApplication: 包装Environment的propertySources为ConfigurationPropertySourcesPropertySource(名为configurationProperties)。

. 打印banner日志。

== 创建ApplicationContext

. 根据ApplicationType创建对应的context

* Servlet: `AnnotationConfigServletWebServerApplicationContext`
* Reactive: `AnnotationConfigReactiveWebServerApplicationContext`
* None-Web: `AnnotationConfigApplicationContext`

. BeanUtils#instantiateClass。

. 初始化AnnotatedBeanDefinitionReader:

.. 设置BeanFactory属性:
* AnnotationAwareOrderComparator
* ContextAnnotationAutowireCandidateResolver
.. 注册spring内置BeanFactoryPostProcessor:
* ConfigurationClassPostProcessor
* AutowiredAnnotationBeanPostProcessor
* RequiredAnnoationBeanPostProcessor
* CommonAnnotationBeanPostProcessor
* PersistenceAnnotationBeanPostProcessor
* EventListenerMethodProcessor
* DefaultEventListenerFactory

. 初始化ClassPathBeanDefinitionReader:

   将@Component @Named @ManagedBean识别为bean.

. 调用ApplicationContextInitializer#initialize:

* DelegatingApplicationContextInitializer: 调用 ```context.initializer.classes```#initialize。
* ContextIdApplicationContextInitializer: 设置ApplicationContext的Id为 ```spring.application.name || "application"```。
* ConfigurationWarningsApplicationContextInitializer: 注册 ```ConfigurationWarningsPostProcessor.```
* ServerPortInfoApplicationContextInitializer: 将自己添加到context的ApplicationListener中。
* SharedMetadataReaderFactoryContextInitializer: 注册```CachingMetadataReaderFactoryPostProcessor.```
* ConditionEvalutionReportLoggingListener: 添加 ```ConfidtionEvalutionReportListener ```。

. 打印启动日志。

. 注册启动类BeanDefinition到BeanFactory中。

. 将SpringApplication中的listener添加到ApplicationContext中。

. 发布**ApplicationPreparedEvent:**

* ConfigFileApplicationListener: 注册 ```PropertySourceOrderingPostProcessor.```
* LoggingApplicationListener: 注册 ```LoggingSystem.```

== Refresh Context:

. prepareRefresh: 清空Scanner缓存。
. prepareBeanFactory:

* 设置ClassLoader/SPEL/ResourceEditorRegistrar属性。
* 注册```ApplicationContextAwarePostProcessor/ApplicationListenerDetector```。
* 注册EnvironmentBean:
** environment
** systemEnvironment
** systemProperties
. postPrcoessBeanFactory: 注册```WebApplicationContextServletContextAwareProcessor```。
. invokeBeanFactoryPostProcessors: 按PriorityOrdered/Ordered/noneOrdered顺序调用```BeanDefinitionRegistry#postProcessBeanDefinitionRegistry&&postProcessBeanFactory```, 再按顺序调用```BeanFactoryPostProcessor#postProcessBeanFactory```。

* ConfigurationWarningsPostProcessor: 检查扫描的包路径是否存在并不以org/org.springframework开头。
* CachingMetadataReaderFactoryPostProcessor:
** 注册 ```SharedMetadataReaderFactoryBean```。
** 设置ConfigurationClassPostProcessor的metadataReaderFactory为```SharedMetadataReaderFactoryBean```。
* ConfigurationClassPostProcessor:
** 扫描并注册BeanDefinition。
** 注册```ImportAwareBeanPostProcessor```。
** 为Configuration类创建CGLIB代理。
* PropertySourceOrderingPostProcessor:将defaultProperties优先级调至最低。
* ProperttSourcesPlaceHolderConfigurer: 替换${...}。
* ConfigurationBeanMetaData: 获取所有的bean method。
* PreserverErrorControllerTargetClassPostProcessor: 设置basicErrorController为CGLIB代理。
. registerBeanPostProcessors: 设置beanPostProcessors属性。
. initMessageSource: 注册messageSource bean为```DelegatingMessageSource```。
. initApplicationEventMulticaster: 注册applicationEventMulticaster为 ```SimpleApplicationEventMulticaster```。
. onRefresh: 创建webserver,将 `servletContext` 设置到 `servletContextInitParams` 中。
. registerListeners: 设置```applicationEventMulticaster``` 的applicationListener(Bean)属性。
. finishBeanFactoryInitialization: 初始化Singleton的BeanDefinition。
. finishRefresh:
* 注册lifeCycleProcessor bean 为 ```DefaultLifeCycleProcessor```。
* 调用实现了SmartLifeCycle接口的bean的start方法。
* 发布**ContextRefreshedEvent**。
* start webServer。
* 发布**ServletWebServerInitializedEvent**。
. reset cache。

== 后置处理:

. 发布**ApplicationStartedEvent**。
. 调用```ApplicationRunner和CommandLineRunner```。
. 发布**ApplicationReadyEvent**。

== 属性配置优先级

. Devtools global settings properties on your home directory (~/.spring-boot-devtools.properties when devtools is active).
. @TestPropertySource annotations on your tests.
. @SpringBootTest#properties annotation attribute on your tests.
. Command line arguments.
. Properties from SPRING_APPLICATION_JSON (inline JSON embedded in an environment variable or system property).
. ServletConfig init parameters.
. ServletContext init parameters.
. JNDI attributes from java:comp/env.
. Java System properties (System.getProperties()).
. OS environment variables.
. A RandomValuePropertySource that has properties only in random.*.
. Profile-specific application properties outside of your packaged jar (application-{profile}.properties and YAML variants).
. Profile-specific application properties packaged inside your jar (application-{profile}.properties and YAML variants).
. Application properties outside of your packaged jar (application.properties and YAML variants).
. Application properties packaged inside your jar (application.properties and YAML variants).
. @PropertySource annotations on your @Configuration classes.
. Default properties (specified by setting SpringApplication.setDefaultProperties).
