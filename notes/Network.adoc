= Computer Network
:icons: font
:source-highlighter: highlightjs
:highlightjs-theme: idea
:hardbreaks:
:sectlinks:
:sectnums:
:stem:
:toc: left
:toclevels: 3
:toc-title: 目录
:tabsize: 4
:docinfo: shared

== 路由

以太网交换机:

 以太网交换机工作在数据链路层, 用于在同一网络中的设备转发以太网帧.

路由器:

 负责不同网络之间的数据包传送.
 路由器通过路由表来确定用于转发数据包的最佳路径.
 当网络向不同IP网络中的设备发送数据包时, 数据包会先被转发到默认网关.

== PDU

|===
| 协议 | PDU | 英文名 | 标识

| 物理层
| 比特
| bit
|

| 链路层
| 帧
| frame
| MAC地址

| 网络层
| 数据包
| packet
| IP地址

| 传输层
| 数据段
| segment
| 端口号

| 应用层
| 报文
| message
| 应用协议

|===

== 数据链路层

=== CSMA/CD

`一个站点首先检测网络上正在发送的信号, 并在网络空闲时发送自己的帧.
如果其他站点碰巧同时发送, 则为一次碰撞. 每个站点等待一个随即时间, 然后再次尝试发送.
随后如果再次碰撞, 等待的时间翻倍. 最终, 每个站点会得到机会发送, 或者在尝试一定次数(16)后超时.
`

=== Ethernet 2帧格式
. 前导字段(8)
. 目标MAC地(6)
. 源MAC地址(6)
. 协议类型(2)
. 上层协议数据(*46-1500字节*)
. FCS(4) 发送和接收由硬件处理

协议类型:

* IPv4 0x0800
* IPv6 0x86dd
* ARP 0x0806
* RARP 0x80length > 1500 ? Ethernet2 : 802.3

=== ARP帧格式
`ARP提供网络层地址到硬件地址的映射`

. 目标地址(1.1.1.1)
. 源地址
. 类型(0x0806)
. 硬件类型(Ethernet(1))
. 协议类型(IPv4)
. 硬件地址大小
. 协议地址大小
. Opcode: ARP请求(1)/应答(2)
. 发送方MAC地址
. 发送方IP地址
. 接收方MAC地址
. 接收方IP地址

== IP
`IP提供了一种尽力而为,无连接的数据包交付服务.`

. 版本(0x0100/0x0110)
. 首部长度(一般为0101)
. Differentiated Service
. Explicit Congestion Notification
. 总长度
. 数据报标识
. 分片标记
. 分片偏移
. 生存时间
. 传输层协议类型
. 头部校验和
. 源IP地址
. 目的IP地址
. 选项

IP数据包最大为65535字节, 当一个IP数据包大于以太网的MTU时, IP协议会把数据包报文切分为多个小的片段.

== TCP

> TCP是一种可靠地, 面向连接的, 基于字节流的, 全双工的协议.

* 面向连接的: 通信双方建立连接时要经过三次握手, 断开连接时要经过四次挥手.
* 可靠地:
** 每个TCP首部都有两字节表示校验和, 如果收到一个校验和有差错的报文, TCP会直接丢弃该报文等待重传.
** TCP的序列号保证了接收数据的顺序.
** TCP在发送数据后会启动一个定时器, 等待对方确认收到这个数据包.
如果在指定时间内没有收到ACK确认包, 就会重传数据包.
** TCP提供了拥塞控制机制.
** 面向字节的: 字节写入内核后, 最终TCP以多少条报文发送出去是不确定的.
** 全双工的: 通信的双方可以同时发送/接收数据.

=== 首部

. 源端口
. 目的端口
. 序列号: 序列号用于保证包的顺序, 或者交换彼此的报文(SYN报文).
. 确认号: TCP使用确认号来告知对方下一个期望接受的序列号.
* 确认号表示小于此确认号的字节都已经收到.
* 不是所有包都需要确认.
* 收到了数据包可以延迟一会儿再确认.
* ACK包不需要确认.
. 首部长度
. 标志位
* Nonce
* Congest Window reduced
* ECN-Echo
* Urgent
* Acknowledgement: 标识确认数据包.
* Push: 告知对方这些数据包收到后应立即交给上层应用, 不能缓存起来.
* Reset: 标识强制断开连接.
* Syn: 标识这个数据包用于发起连接时同步双方的初始序列号.
* Fin: 告知对方自己发送完了所有数据, 后续不会再有数据发送了.
. 窗口大小: 窗口大小值*缩放因子
. 校验和
. 紧急指针
. 可选项/Padding

=== MSS

TCP MSS = MTU - IP header头大小 - TCP 头大小 (stem:[1500-20-20=1460])

=== 端口号

端口号被划分成以下 3 种类型：

* 熟知端口号（0~1023)
* 已登记的端口（1024~49151）
* 临时端口号（49152~65535）`cat /proc/sys/net/ipv4/ip_local_port_range`

=== 三次握手

. [C]客户端发送SYN包. `SYN-SENT`
. [S]服务端接收到后加一作为ACK包, 然后自己生成一个SYN包一起发送. `SYN-RCVD`
. [C]客户端接收到服务端的SYN包加一, 作为ACK包发送给服务端. `ESTABLISHED`

=== 四次挥手

. [C]客户端发送FIN包, 以后客户端不能再发送数据给服务端了. `FIN-WAIT-1`
. [S]服务端接收到后回复ACK包. `CLOSE-WAIT`
. [C]客户端接收到ACK包. `FIN-WAIT-2`
. [S]服务端发送FIN包. `LAST-ACK`
. [C]客户端收到FIN包, 发送ACK包. `TIME-WAIT`
. [S]服务端收到ACK包断开连接. `CLOSED`
. [C]客户端经过两个MSL后断开连接. `CLOSED`

== Appendix

. 路由器的主要功能和特性是什么？
. 在小型路由网络中，如何将设备连接起来？
. 如何使用CLI配置路由器上的基本设置，以实现两个直连网络之间的路由？
. 如何检验直连到路由器的两个网络之间的连接？
. 在接口之间交换数据包时，路由器使用的封装和解封装的过程是什么？
. 什么是路由器的路径决定功能？
. 直连网络的路由表条目是什么？
. 路由器如何创建直连网络的路由表？
. 路由器如何使用静态路由创建路由表？
. 路由器如何使用动态路由协议创建路由表？
